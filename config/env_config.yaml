# ========================================
# 环境变量配置文件
# 从 Workflow 系统变量迁移而来
# ========================================

# ======================================
# 1. Gamma 状态判定参数
# ======================================
gamma:
  # EM1$ 计算因子 sqrt(1/252)
  em1_sqrt_factor: 0.06299
  
  # 破墙判定阈值
  break_wall_threshold_low: 0.4      # gap < 0.4×EM1$ 高破墙概率
  break_wall_threshold_high: 0.8     # gap > 0.8×EM1$ 低破墙概率
  
  # 月度簇判定
  monthly_override_threshold: 0.7    # 月度簇强度 ≥ 周度×0.7 时覆盖
  monthly_cluster_strength_ratio: 1.5
  
  # 簇强度阈值
  cluster_strength_threshold_t: 1.2  # 趋势级别
  cluster_strength_threshold_s: 2.0  # 极强级别
  
  # 墙识别参数
  wall_cluster_width: 3              # 簇宽度 ≥ 3 个相邻行权价
  wall_peak_multiplier: 2.0          # 局部峰 ≥ 相邻γ中位数 2 倍
  # Lambda 扩展系数参数
  lambda_k_sys: 0.5              # 系统性溢价系数
  lambda_k_idiosync: 0.5         # 特质性补偿系数
  lambda_vix_base: 15.0          # VIX 长期中枢
  lambda_ivr_floor: 30.0         # IVR 低波防爆阈值

# ======================================
# 2. 方向信号阈值
# ======================================
direction:
  # DEX 同向阈值
  dex_same_dir_threshold_strong: 70  # ≥70% 强方向
  dex_same_dir_threshold_medium: 60  # ≥60% 中等方向
  dex_same_dir_threshold_weak: 50    # ≥50% 弱方向
  
  # IV 路径阈值
  iv_path_threshold_vol: 2           # 绝对变化 ≥ 2 vol点
  iv_path_threshold_pct: 10          # 相对变化 ≥ 10%
  iv_noise_threshold: 30             # 7D与14D差异 >30% 视为噪音

# ======================================
# 3. DTE（到期日）选择逻辑
# ======================================
dte:
  # Gap 距离阈值（× EM1$）
  gap_high_threshold: 3              # gap > 3×EM1$ 选择长DTE
  gap_mid_threshold: 2               # gap 在 2-3×EM1$ 中等DTE
  
  # 默认 DTE 值
  default_weekly_short: 7            # 周度短期
  default_weekly_mid: 14             # 周度中期
  default_monthly_short: 30          # 月度短期
  default_monthly_mid: 60            # 月度中期（无周度数据时使用）
  
  # 月度调整
  monthly_adjustment: 7              # 月度簇时 DTE+7天

# ======================================
# 4. 行权价偏移（× EM1$）
# ======================================
strikes:
  # 保守策略
  conservative_long_offset: 1.5      # Long腿距Short腿 1.5×EM1$
  
  # 均衡策略
  balanced_wing_offset: 1.0          # Wing距Body 1.0×EM1$
  
  # 进取策略
  aggressive_long_offset: 0.2        # Long腿距现价 0.2×EM1$
  
  # 比率价差
  ratio_short_offset: 0.5            # Short腿偏移
  ratio_long_offset: 1.5             # Long腿偏移

# ======================================
# 5. 价差宽度（× EM1$）
# ======================================
spreads:
  # 信用价差
  credit_min_width: 0.8
  credit_max_width: 1.0
  
  # 借贷价差
  debit_min_width: 1.0
  debit_max_width: 1.2

# ======================================
# 6. RR（风险回报比）计算 - IVR 映射
# ======================================
rr_calculation:
  # 信用价差 credit_ratio
  credit_ivr:
    "0-25": 0.20                     # IVR 0-25%
    "25-50": 0.30                    # IVR 25-50%
    "50-75": 0.40                    # IVR 50-75%
    "75-100": 0.50                   # IVR 75-100%
  
  # 借贷价差 debit_ratio
  debit_ivr:
    "0-40": 0.30
    "40-70": 0.40
    "70-100": 0.50

# ======================================
# 7. Pw（胜率）计算参数
# ======================================
pw_calculation:
  # 信用策略 Pw
  credit:
    base: 0.5                        # 基础胜率
    cluster_coef: 0.1                # 簇强度系数
    distance_penalty_coef: 0.05      # 距离惩罚系数
    min: 0.4                         # 最小值
    max: 0.85                        # 最大值
  
  # 借贷策略 Pw
  debit:
    base: 0.3
    dex_coef: 0.1                    # DEX 调整系数
    vanna_coef: 0.2                  # Vanna 调整系数
    vanna_weight_high: 1.0           # Vanna权重 - 高
    vanna_weight_medium: 0.6         # Vanna权重 - 中
    vanna_weight_low: 0.3            # Vanna权重 - 低
    min: 0.25
    max: 0.75
  
  # 蝶式策略 Pw
  butterfly:
    body_inside: 0.65                # spot 在 body 内
    body_offset_1em: 0.45            # 偏离 1×EM1$

# ======================================
# 8. Greeks 目标范围
# ======================================
greeks:
  # 保守策略（接近中性）
  conservative:
    delta_min: -0.1
    delta_max: 0.1
    theta_min: 5.0                   # 每日Theta收益 ≥ 5
    vega_max: -10.0                  # 做空波动率
  
  # 均衡策略
  balanced:
    delta_range: 0.2                 # Delta 在 ±0.2
    theta_min: 8.0
  
  # 进取策略（明确方向）
  aggressive:
    delta_min: 0.3
    delta_max: 0.6
    vega_min: 10.0                   # 做多波动率

# ======================================
# 9. 止盈止损参数
# ======================================
exit_rules:
  # 信用策略
  credit:
    profit_target_pct: 30            # 权利金衰减至 30% 止盈
    stop_loss_pct: 150               # 浮亏达 150% 止损
    time_decay_exit_days: 3          # 到期前 3 日强制平仓
  
  # 借贷策略
  debit:
    profit_target_pct: 60            # 浮盈 60% 止盈
    stop_loss_pct: 50                # 亏损 50% 止损
    time_decay_exit_days: 3

# ======================================
# 10. 评分权重配置
# ======================================
scoring:
  # 四维评分权重（默认值，IVR 正常期使用）
  weight_gamma_regime: 0.4           # Gamma状态权重
  weight_break_wall: 0.3             # 破墙可能性权重
  weight_direction: 0.2              # 方向一致性权重
  weight_iv: 0.1                     # IV动态权重
  weight_index_consistency: 0.10     # 指数权重
  
  # 动态权重配置（根据 IVR 自动调整）
  dynamic_weights:
    # 恐慌期 (IVR > 80)：波动率均值回归是主导，结构不可靠
    panic:
      ivr_threshold: 80              # IVR 上限阈值
      gamma: 0.2
      break: 0.2
      direction: 0.2
      iv: 0.4
      description: "恐慌期：IV均值回归主导，结构信号弱化"
    
    # 平静期 (IVR < 20)：波动率已死，结构是唯一波动源
    calm:
      ivr_threshold: 20              # IVR 下限阈值
      gamma: 0.5
      break: 0.3
      direction: 0.1
      iv: 0.1
      description: "平静期：结构主导，IV信号无效"
    
    # 正常期 (20 <= IVR <= 80)：使用默认权重
    normal:
      gamma: 0.4
      break: 0.3
      direction: 0.2
      iv: 0.1
      description: "正常期：平衡权重"
  
  index_gap_threshold_ratio: 0.5     # 破墙距离阈值（倍数）
  index_conflict_penalty: -1         # 方向冲突惩罚分
  index_consistency_bonus: 1         # 一致性加分
  
  # 入场阈值
  entry_threshold_score: 3           # 总评分 ≥ 3分
  entry_threshold_probability: 60    # 主导场景概率 ≥ 60%
  light_position_probability: 50     # 轻仓试探概率下限
  technical_score_max: 2             # 技术面最高 2分

# ======================================
# 11. 风险管理
# ======================================
risk_management:
  max_single_risk_pct: 2             # 单笔风险 ≤ 账户2%
  max_total_exposure_pct: 10         # 总敞口 ≤ 账户10%

# ======================================
# 12. Alpha Vantage API 配置
# ======================================
alpha_vantage:
  api_url: "https://www.alphavantage.co/query?"
  api_key: "TKV2HLJJYKSRGR"          # ⚠️ 建议从环境变量读取
  enable_earnings_api: true          # 是否启用财报API
  earnings_cache_days: 90            # 财报缓存天数

# ======================================
# 13. 数据抓取默认值
# ======================================
data_fetching:
  default_strikes: 25                # 默认行权价数量
  default_net_window: 60             # 净Gamma窗口（天）
  extended_net_window: 120           # 扩展窗口
  default_index_primary: "SPX"       # 主要指数
  default_index_secondary: "QQQ"     # 次要指数

# 控制台输出配置
console:
  enable_color: true                # 是否启用颜色
  show_full_output: false           # 是否显示完整输出
  max_content_length: 1000          # 内容最大长度
  json_max_depth: 3                 # JSON 显示深度

vision:
  image_detail: "high"  # 图片分析精度
  # 可选值:
  #   - "low": 512px分辨率, 低Token消耗 (~85 tokens/图)
  #            适合: 简单图标、Logo识别
  #   - "auto": 自适应分辨率, 平衡精度和成本 (~170 tokens/图)
  #            适合: 一般图表、文档扫描
  #   - "high": 2048px+分辨率, 高精度 (~765 tokens/图)
  #            适合: 复杂期权图表、精确数字识别（推荐）
  # 
  # 对于期权数据分析，推荐使用 "high":
  #   - 更准确识别小数字（GEX值、行权价）
  #   - 更精确的曲线识别（Gamma分布、Skew）
  #   - 更清晰的标签读取（图表注释、Legend）

# ======================================
# 10. Beta 敏感度配置
# ======================================
beta:
  # 板块默认 Beta 值
  # 用于在无法获取实时 Beta 时的默认估算
  sector_defaults:
    # 高 Beta 板块 (> 1.3)
    semiconductor: 1.5      # 半导体
    tech_growth: 1.4        # 科技成长
    ev: 1.4                 # 电动车
    biotech: 1.5            # 生物科技
    crypto: 1.8             # 加密货币相关
    
    # 标准 Beta 板块 (0.7 - 1.3)
    tech_large: 1.1         # 大型科技
    consumer: 1.0           # 消费
    industrial: 1.0         # 工业
    financial: 1.1          # 金融
    
    # 低 Beta 板块 (< 0.7)
    utilities: 0.5          # 公用事业
    healthcare: 0.7         # 医疗保健
    consumer_staples: 0.6   # 必需消费品
    reits: 0.8              # REITs
  
  # 常见股票的 Beta 预设（优先级最高）
  stock_overrides:
    # 高 Beta（> 1.3）
    NVDA: 1.7
    AMD: 1.6
    TSLA: 2.0
    MSTR: 2.5
    SMCI: 1.8
    ARM: 1.5
    AVGO: 1.3
    MU: 1.5
    COIN: 2.0
    
    # 标准 Beta（0.7 - 1.3）
    AAPL: 1.2
    MSFT: 1.1
    GOOGL: 1.1
    AMZN: 1.2
    META: 1.3
    NFLX: 1.4
    CRM: 1.2
    
    # 低 Beta（< 0.7）
    JNJ: 0.6
    PG: 0.5
    KO: 0.6
    VZ: 0.4
    T: 0.5
    XOM: 0.9
    CVX: 1.0
  
  # 股票到板块的映射（用于未在 stock_overrides 中的股票）
  symbol_to_sector:
    # 半导体
    INTC: semiconductor
    QCOM: semiconductor
    TXN: semiconductor
    KLAC: semiconductor
    LRCX: semiconductor
    AMAT: semiconductor
    
    # 电动车
    RIVN: ev
    LCID: ev
    NIO: ev
    XPEV: ev
    LI: ev
    
    # 大型科技
    UBER: tech_large
    ABNB: tech_large
    SNOW: tech_growth
    PLTR: tech_growth
  
  # 敏感度系数阈值
  sensitivity:
    high_beta_threshold: 1.3    # Beta > 1.3 视为高敏感
    low_beta_threshold: 0.7     # Beta < 0.7 视为低敏感
    k_sys_high: 0.8             # 高 Beta 股票的 k_sys
    k_sys_standard: 0.5         # 标准 Beta 股票的 k_sys
    k_sys_low: 0.3              # 低 Beta 股票的 k_sys
    
    # 财报相关
    earnings_warning_days: 14   # 距财报 ≤ 14天提高防御
    k_idiosync_high: 1.0        # 临近财报时的 k_idiosync
    k_idiosync_normal: 0.5      # 常规 k_idiosync
  
  # 默认值（当无法确定时使用）
  default_beta: 1.0